<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/topojson-client@3"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <title>D3 Charts</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "DM Sans", sans-serif;
      }

      .container {
        width: 100%;
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .candidate {
        font-weight: bold;
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      tr {
        text-align: left;
      }

      td,
      th {
        padding: 5px 20px;
        padding-left: 0px;
      }

      .tooltip {
        position: absolute;
        background: #fff;
        border: 1px solid #ccc;
        border-radius: 5px;
        padding: 5px;
        font-size: 12px;
        pointer-events: none;
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div id="chart"></div>
      <div class="tooltip"></div>
    </div>
    <script>
      const width = 1000;
      const height = 800;
      // draw a map of nigeria using d3
      Promise.all([
        d3.json("data/nigeria-states.json"),
        d3.csv("data/election.csv"),
      ]).then((data) => {
        const [states, election] = data;

        election.forEach((d) => {
          d.APC = +d.APC;
          d.PDP = +d.PDP;
          d.PCP = +d.PCP;
          d.ADC = +d.ADC;
          d.APGA = +d.APGA;
        });

        const candidates = {
          APC: "Muhammadu Buhari (APC)",
          PDP: "Atiku Abubakar (PDP)",
          PCP: "Felix Nicolas (PCP)",
          ADC: "Obadiah Mailafia (ADC)",
          APGA: "Gbor John Wilson Terwase (APGA)",
        };
        const percentage = [40, 45, 50, 55, 60, 65, 70, 75, 80, 85, 90];

        // create a color scale
        const PDPColourScale = d3
          .scaleOrdinal()
          .domain([40, 45, 50, 55, 60, 65, 70, 75, 80, 85, 90])
          .range([
            "#A3FFA6",
            "#70FF74",
            "#4FFF42",
            "#4FFF0C",
            "#41D605",
            "#2FA302",
            "#258602",
            "#1B6902",
            "#135202",
            "#0A3802",
            "#042002",
          ]);

        const APCColourScale = d3
          .scaleLinear()
          .domain([40, 45, 50, 55, 60, 65, 70, 75, 80, 85, 90])
          .range([
            "#B4D6F3",
            "#87BEEB",
            "#5FAAE2",
            "#3290DD",
            "#246CB0",
            "#1C5A90",
            "#164979",
            "#113F64",
            "#0D314F",
            "#092539",
            "#041525",
          ]);

        // create a state map using d3
        const svg = d3
          .select("#chart")
          .append("svg")
          .attr("width", 1000)
          .attr("height", 800)
          .style("border", "1px solid #ccc")
          .style("border-radius", "10px");

        // create a projection
        const projection = d3
          .geoMercator()
          .scale(4000)
          .center([8.5, 9.5])
          .translate([500, 400]);

        // create a path generator
        const pathGenerator = d3.geoPath().projection(projection);

        // create a group for the states
        svg
          .append("g")
          .attr("class", "states")
          .attr("cursor", "pointer")
          .selectAll("path")
          .data(topojson.feature(states, states.objects.NGA_adm1).features)
          .enter()
          .append("path")
          .attr("d", pathGenerator)
          .attr("fill", function (d) {
            const state = election.find((e) => e.State === d.properties.NAME_1);

            const winner = Object.keys(state).reduce((a, b) =>
              state[a] > state[b] ? a : b
            );
            // return winning percentage
            const percentage = (
              (state[winner] /
                Object.values(state)
                  .splice(1)
                  .reduce((a, b) => a + b)) *
              100
            ).toFixed(2);

            return winner === "APC"
              ? APCColourScale(percentage)
              : PDPColourScale(percentage);
          })
          .attr("stroke", "white")
          .attr("stroke-width", 1)
          .on("mousemove", function (e, d) {
            d3.select(this).attr("opacity", 0.8);
            const tooltip = d3.select(".tooltip");
            const state = election.find((e) => e.State === d.properties.NAME_1);
            const winner = Object.keys(state).reduce((a, b) =>
              state[a] > state[b] ? a : b
            );
            tooltip
              .style("left", e.pageX + 10 + "px")
              .style("top", e.pageY + 10 + "px")
              .style("display", "block").html(`
              <h2>${d.properties.NAME_1}</h2>
                <table>
                  <thead>
                    <tr>
                      <th>Candidate</th>
                      <th>Votes</th>
                      <th>Percentage</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${Object.keys(state)
                      .splice(1)
                      .map(
                        (key) =>
                          `<tr style='background-color: ${
                            key === winner ? "gray" : "inherit"
                          }'>
                            <td class='candidate'>${candidates[key]}</td>
                            <td>${state[key]}</td>
                            <td>${(
                              (state[key] /
                                Object.values(state)
                                  .splice(1)
                                  .reduce((a, b) => a + b)) *
                              100
                            ).toFixed(2)}%</td>
                          </tr>`
                      )
                      .join("")}
                  </tbody>
              `);
          })
          .on("mouseout", function () {
            d3.select(this).attr("opacity", 1);
            d3.select(".tooltip").style("display", "none");
          });

        // append state names
        svg
          .append("g")
          .attr("class", "state-names")
          .selectAll("text")
          .data(topojson.feature(states, states.objects.NGA_adm1).features)
          .enter()
          .append("text")
          .attr("x", (d) => pathGenerator.centroid(d)[0])
          .attr("y", (d) => pathGenerator.centroid(d)[1])
          .attr("text-anchor", "middle")
          .attr("pointer-events", "none")
          .attr("font-size", 10)
          .attr("font-weight", "bold")
          .attr("fill", "white")
          .text((d) =>
            d.properties.NAME_1 === "Federal Capital Territory"
              ? "FCT"
              : d.properties.NAME_1
          );

        const legend = svg
          .append("g")
          .attr("class", "legend")
          .attr("transform", `translate(${width - 400}, ${height - 100})`);

        // legend for APC
        legend
          .append("g")
          .attr("class", "apc-legend")
          .attr("transform", "translate(20, 20)")
          .selectAll("rect")
          .data(percentage)
          .enter()
          .append("rect")
          .attr("x", (d, i) => i * 30)
          .attr("y", 0)
          .attr("width", 30)
          .attr("height", 20)
          .attr("fill", (d) => APCColourScale(d));

        // legend for PDP
        legend
          .append("g")
          .attr("class", "pdp-legend")
          .attr("transform", "translate(20, 45)")
          .selectAll("rect")
          .data(percentage)
          .enter()
          .append("rect")
          .attr("x", (d, i) => i * 30)
          .attr("y", 0)
          .attr("width", 30)
          .attr("height", 20)
          .attr("fill", (d) => PDPColourScale(d));

        // legend text
        legend
          .append("g")
          .attr("transform", "translate(20, 0)")
          .selectAll("text")
          .data(percentage)
          .enter()
          .append("text")
          .attr("x", (d, i) => i * 30)
          .attr("y", 0)
          .attr("dx", 15)
          .attr("dy", 15)
          .attr("text-anchor", "middle")
          .attr("font-size", 10)
          .attr("fill", "black")
          .text((d) => d + "%");

        d3.selectAll(".apc-legend")
          .append("text")
          .attr("x", 0)
          .attr("y", 0)
          .attr("dx", -10)
          .attr("dy", 15)
          .attr("text-anchor", "end")
          .attr("font-size", 14)
          .attr("font-weight", "bold")
          .attr("fill", "black")
          .text("APC");

        d3.selectAll(".pdp-legend")
          .append("text")
          .attr("x", 0)
          .attr("y", 0)
          .attr("dx", -10)
          .attr("dy", 15)
          .attr("text-anchor", "end")
          .attr("font-size", 14)
          .attr("font-weight", "bold")
          .attr("fill", "black")
          .text("PDP");
      });
    </script>
  </body>
</html>
